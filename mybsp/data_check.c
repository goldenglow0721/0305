#include "stdint.h"
#include <string.h>
#include "data_check.h"
#include "bsp_qspi_flash.h"

/* crc32校验值 

Total sectors: 988   size: 998*4 = 3992字节

*/
int data_crc32_4k[] =
{
0xcde45f29, 0xf3026c3a, 0x13405bf3, 0xcb90e9aa, 0xf051586e, 0x8340ac34, 0x51850a56, 0x4df12710, 
0x86b7a06d, 0xea54763d, 0x7d427e95, 0xbb28901b, 0x01ca07e6, 0x47364948, 0x4cc78f0a, 0x76684852, 
0xee531d5a, 0x9405e453, 0x01f2f47b, 0xb6fb25d0, 0x2fb5fe9d, 0x8700a4f2, 0x072e4f9e, 0x22d770d2, 
0x3a06cd11, 0xc676c4a0, 0x724347bb, 0x8a2241b6, 0xa9f54355, 0xc8786b0e, 0xf33a513f, 0xa0cc5076, 
0x644cd418, 0xca427a65, 0x711b2223, 0x5294bded, 0xf93641da, 0xa6e0322c, 0x8ef09a05, 0x2c0d1b2c, 
0x660f433c, 0x42ff9017, 0x14dfd322, 0x6f75046d, 0x0b93169d, 0xae9dffdb, 0x2b219fd2, 0xe5a690b3, 
0x81982bb8, 0x2ba39320, 0x286cc297, 0x57c9413b, 0x51b71197, 0x2f831989, 0x3afc68e2, 0xdc004615, 
0x222c5c1c, 0x3f17b101, 0x3aa314a6, 0x0558ff16, 0xa8e1b751, 0xa3b1c93c, 0xc02b3048, 0x7a605738, 
0x68c203e0, 0xcd092aa3, 0x1288f2cc, 0x9538bc2c, 0x9c1b936f, 0xac596a49, 0xfb919a02, 0x27e62bbb, 
0x1a137a82, 0x23060ee3, 0xe5845c9a, 0x03e41cfc, 0xcc273109, 0xc69fb3b7, 0xad893c64, 0x01167981, 
0xc31ef294, 0xd453244b, 0x34613408, 0x7612e96b, 0x8908b534, 0xc573f87d, 0xabfdd075, 0xfe48e17f, 
0xd414869d, 0xfeed1fb3, 0xdbf618be, 0x4ac333df, 0x19d17839, 0x49043f15, 0xb31d95b3, 0x4372181e, 
0x97e28249, 0x8bdc1df0, 0x385a4b4b, 0x8926cb91, 0xb363c3ae, 0xa3dad906, 0x5ffd4639, 0xf4c7bf11, 
0x03ed9eb6, 0xb57f75e6, 0x7bb55a2c, 0xa9780c9f, 0xd2a3b675, 0x0bc59557, 0x8d681ae3, 0x3989cb42, 
0xc245136a, 0x8fbfa28c, 0x28b52ced, 0x2d25275e, 0x6817f3c5, 0xae249637, 0xd27276ee, 0x225caa85, 
0xa2dacca6, 0x216205fc, 0xf7fed231, 0x0f978542, 0x43fc8b53, 0x293f9564, 0xaa8e1ab3, 0xc49fbf81, 
0x808945cd, 0xef762f10, 0xbf121772, 0x7a9f7cae, 0x6fd6d86a, 0xf2e03784, 0xd276c15c, 0x23e85bee, 
0xbcdf24bb, 0xaaf3e2c4, 0x2e701888, 0x7c943356, 0x41d0f764, 0xf524bb8d, 0x0e9d3432, 0xbf35402b, 
0xfb88ce41, 0xe7f1d3d8, 0x99a1ce8f, 0xa623b0be, 0x987926d4, 0x367a6a3a, 0xf760281d, 0x6185df39, 
0xef8df620, 0xa0cf50df, 0x7ffd8a16, 0x9dbc29de, 0x7a190bd1, 0x76b792d3, 0xe260c600, 0x0371d18a, 
0x729c60d6, 0x18a94753, 0x7efa09c4, 0x0f3def37, 0x05dde710, 0xc3e657a8, 0xa29af403, 0x0f2ad860, 
0xb307641e, 0x1258ccf9, 0xf77c6da3, 0x93ecd61c, 0x2ff6ed29, 0xf7acf243, 0x4ff289f7, 0xf95f7212, 
0x8c6b0ff5, 0xa0da3588, 0x88cd7d98, 0x911b3726, 0x1d6b735a, 0xe34a2b25, 0x4dbdf9dd, 0x3c19ff83, 
0xdb02649d, 0x57a0272d, 0x87ba9dd9, 0xbc0901cb, 0x7d5264f9, 0xda94e7b3, 0x72dbe75a, 0xc676cc0a, 
0xfe039f50, 0xfcd8a343, 0x7d8a0f22, 0x00f666a3, 0x09f533e3, 0x859e8cea, 0x9845e668, 0x7c527ce3, 
0x1c53a92a, 0xd0dcf2a5, 0xbce9169d, 0xb88b1fac, 0x96f67dd7, 0xd91680e2, 0xe91212e5, 0x6a345a82, 
0xedd67d69, 0xf46d0b65, 0x339bffe9, 0x32a3fda3, 0x099a562b, 0x8d81af58, 0x1769e765, 0x27373ea5, 
0x1e226746, 0x080bc6b5, 0x3cdbf2b5, 0xd233b8c9, 0xa570a1cd, 0xb42e7312, 0xf652aa55, 0x861f8fef, 
0x36555851, 0xc93d1a0a, 0xbb17265c, 0xd2eedef3, 0xae917871, 0x680da635, 0x6cdb4816, 0x60fa0ae5, 
0xfacc9833, 0xd329c4a2, 0x7fbe370f, 0x517a1b4f, 0x1650d52a, 0xd95c923e, 0xb944ee69, 0x827666b6, 
0x28027699, 0x173ecd51, 0xbdd2a4a5, 0xe16761e2, 0x7998cef3, 0xf0621e57, 0xf77f460c, 0x472361fa, 
0x0677b8e2, 0xf56e8eed, 0xd05244f0, 0xf3979a9d, 0xc2a0b5df, 0x5b0fd048, 0x7a8d6587, 0x9f0d66cb, 
0x0ddf4009, 0xc1aff8a1, 0x7bebe2ef, 0x6bbd2509, 0xa08e33b0, 0x0a6e684a, 0x72aaa7f6, 0x0f40f814, 
0x6b84cb62, 0x7456c58e, 0x9619e312, 0xff36c254, 0x40d04cd1, 0x43d0464d, 0xed96c906, 0xbf8f3b9f, 
0xe1ffb384, 0xfb55797d, 0x7ca38909, 0x1e9f7a8b, 0x26494544, 0xb53b29fa, 0x20cf3875, 0xc0734ebb, 
0xe5615a1d, 0x86d43acf, 0xebfbc798, 0x2e9e15a7, 0x55a168d9, 0xaf077e67, 0xf85ed2d7, 0xf37b9569, 
0x4ef402b9, 0xa6152a00, 0xe6ccd7ce, 0x67c847d3, 0x62cb4d67, 0x27ebb39e, 0x147f8078, 0xd40c5c01, 
0xd6565500, 0xa8cff9a9, 0xc70512d9, 0xee204dcd, 0x415ca8be, 0x5daa8b7b, 0x5cf00e7a, 0x88e17831, 
0x13569bb1, 0x756930f4, 0x4473d7e3, 0xb2b69476, 0xab723842, 0x0000a8ab, 0x2e78e24a, 0xe4efd5d7, 
0x42360541, 0xf484d318, 0x2d9688be, 0x30554337, 0x31ab831a, 0xd3705145, 0xdd8f2faa, 0x676b37f4, 
0x01837552, 0xf7a6b515, 0xca45b9a6, 0xcb057e64, 0xfef3f70b, 0xa5e96d11, 0x7d8d8ea0, 0x65a01b09, 
0x45f99c68, 0xc433153a, 0x2f74c923, 0x869c5753, 0xb3a5ae08, 0x5212d443, 0x0f308edc, 0x3887290e, 
0xbc610cf4, 0xefac4e63, 0x224a7130, 0x1dc3ceb6, 0x5ef55cbe, 0xce760a51, 0xde037f30, 0x0c5c1dd5, 
0x288db478, 0x62506e09, 0x3d44d55b, 0x53312dd2, 0x4ccc83d3, 0xc2224a52, 0x51f6f069, 0xe4d5d534, 
0xac7d1cd6, 0x22c621d0, 0xb420e693, 0x0839a152, 0xb583d287, 0x8a57b27b, 0xc79aea56, 0x611c376c, 
0x2f7dae22, 0x77c3f36b, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0x35e6f9d1, 0x4e81a7d4, 0x6d15844d, 0xeae495fc, 0xcb44ad22, 0x5754a68b, 
0xacfab44b, 0x73b10728, 0x39a72e94, 0x060ca44c, 0x75de3bb6, 0x22a9e78a, 0xa434766d, 0xaf46f8c8, 
0xe8e794d8, 0x26c87433, 0xe829af02, 0x8de2e1a0, 0xe59c3e05, 0xae10727d, 0x20b9c7ae, 0x5124c5a3, 
0x6a810d74, 0x2bf0a0c6, 0x0a4fcd8b, 0xcbbad993, 0xc6c706f8, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xbed7ee50, 0x176a932e, 0x80903acf, 
0xbe1fea44, 0x7f0e385d, 0x3254189a, 0x5d9149fb, 0x5a3da2af, 0x2e453d6e, 0x3fd5811b, 0x60678806, 
0x840a1863, 0x53267cac, 0x8ee1e8dd, 0x71b1c68b, 0x0da2df48, 0x5749fcf0, 0x015a5916, 0x4aebfc3c, 
0xeefd6541, 0x68668c59, 0xefd653e3, 0xf223b1e8, 0x48b8d5fe, 0x957b1d45, 0x29ee4c13, 0x70a2e8ca, 
0xf1c56132, 0x97948ddd, 0xb9a72652, 0x6c71728d, 0x34ecdafa, 0xe4dda44d, 0xbebc5f55, 0x19ae2f3f, 
0x5745ab4c, 0x50265845, 0x0fc0fd7f, 0x32cfe43a, 0x32e48293, 0xca990f84, 0x3a29a612, 0xbf30d896, 
0x30db8af8, 0x6f7d96c5, 0x0289a3a6, 0x91e5d456, 0xe3e62a83, 0xcaf91228, 0xc61d8db2, 0x74e7edc4, 
0x0cf3b604, 0xdad0b281, 0xf154670a, 0x56d838fd, 0xe097f807, 0x58d777c3, 0x49b1e6a7, 0x387f8dd6, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xde0b0d4d, 0xa561b0f3, 
0xb0ce7321, 0xb63d1fa1, 0x191a0de5, 0x2f8c54aa, 0x8d00f1a1, 0x340be19c, 0x12ae0d76, 0xb4807f82, 
0xbc611034, 0x519b511b, 0x2248da72, 0x7804a1e5, 0xedda8c1c, 0x5f9c7212, 0x90431217, 0xfe755c29, 
0xca0ee78b, 0x8863f174, 0xf3eb23d4, 0x5c1fa696, 0x330d3b8d, 0x6ad4be0f, 0xcd143f41, 0x0b6b0bfe, 
0x5c5827ce, 0x3ce6d61c, 0x340c953c, 0x40055620, 0x13f82c4b, 0x9dc4b185, 0xb213d6bf, 0xae6daab3, 
0x3e592930, 0x44d57068, 0x3ee2bbed, 0x369a1e28, 0x67c09bf5, 0x2e3b2eef, 0xddea93c0, 0xe047d47f, 
0x3af8861c, 0xf5c05eb9, 0x75a5f67d, 0xbd615e37, 0xc823fb2f, 0xe1c9669e, 0x2ee79118, 0x968b1e8c, 
0x17c7352d, 0x257995ac, 0x3cb79526, 0xda3e721b, 0x177e3935, 0x30a5a126, 0x7bbded32, 0x40d6c330, 
0xbfccc228, 0xca723a43, 0xea485a7c, 0x2b3868e1, 0x0b4953a0, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0x78882778, 0x9a7273de, 0xe36a7e43, 0xd4a1972c, 0x1be2cced, 0x15f664ae, 0x8c383b5c, 0x9c15bc37, 
0xdf1d8707, 0xcd33b4ac, 0x0879486a, 0x65c76d6e, 0x23e87745, 0x7b199372, 0xa82bf333, 0x028a5131, 
0xb9889cf0, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0x74b7ab19, 0xef00ae6f, 0xd344c992, 0xdf9d69a6, 
0x0969dd70, 0x69581eeb, 0xf25cdf52, 0x017298ee, 0x91bbd4f5, 0x9f02299d, 0xe75510a2, 0x5138b30c, 
0x88868ceb, 0x3196fbe4, 0x9b86166f, 0xfade6228, 0xf154670a, 0xf154670a, 0xf2b89b23, 0x3439cf41, 
0x35931060, 0xca4cf215, 0x03dd40fa, 0x5d53ba5d, 0x8153ac7d, 0xf8ac3b8e, 0x3d279dca, 0x6505016f, 
0x6066ac2b, 0xe8f0b687, 0xf4a5d8c8, 0xb23ae5dd, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0x75108fa3, 0xede78e66, 
0x20a59189, 0x717bd5c1, 0xb93cef8f, 0xcadb225f, 0x8158bd1d, 0xc9c5bcf3, 0x685fee6d, 0x7d72615a, 
0xd5f01b01, 0x1bb77da3, 0x655ba71e, 0xee460fc6, 0x8b7b5ca7, 0x325fda3d, 0xf154670a, 0xf154670a, 
0x7f8c919c, 0x75d2b9e9, 0x5f072b33, 0x96cd8e45, 0x27187ca6, 0x6dd3d6ff, 0x46974d34, 0x315db517, 
0xd4fd6d34, 0xfb19a804, 0x3328ada6, 0x7d0bbc9b, 0x3bdd1802, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xd34c1c90, 0xb236c0f8, 0xaa374373, 0xa7838980, 0x0ee89682, 
0xc94e5a51, 0x6cab406f, 0x8c739054, 0xcb69d75b, 0x678218fe, 0x5473b0c5, 0x2911f6c7, 0x8bea7148, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0x71c0a9ee, 0x232a7f35, 0x7d066823, 0x5bd6aeb2, 
0xccce4746, 0xc8aa4d49, 0x41e81708, 0x051aa6b8, 0x4e8c0993, 0x648fece6, 0xa4854797, 0x557e1848, 
0x6806a331, 0x92cc8c7f, 0xeb4dcb1d, 0xebc1fe2e, 0x00a7dd06, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 0xf154670a, 
0xf154670a, 0xed9cb5fd, 0x2fc8519f, 0x25dcbcc7, 0x0f891939, 0x32d4c37f, 0xdf94de17, 0x6c153e83, 
0xcda38cf4, 0x6d54541d, 0x16a74c2e, 0x6b6004ee, 0x42be50d3, 0xe5823a43, 0x6ebc409f, 0xf5d1d9ce, 
0x65b71445, 0x18cffe3c, 0x7c1e15de, 0x9653b2a1, 0x13a2700c, 0xdb5ba584, 0xadb838be, 0x1e4015d0, 
0x8b58a27f, 0x13c937aa, 0x04365618, 0x2250b574
};

		
  #define CRC32_POLYNOMIAL 0xEDB88320u

/*
 软件crc32
 传入参数：   数据首地址     数据大小
*/

  static uint32_t soft_calculate_crc32(const void *data, size_t size) 
{
    const uint8_t *byteData = (const uint8_t *)data;
    uint32_t crc = 0xFFFFFFFFu;

    for (size_t i = 0; i < size; ++i) {
        crc ^= byteData[i];
        for (int j = 0; j < 8; ++j) {
            crc = (crc >> 1) ^ ((crc & 1) ? CRC32_POLYNOMIAL : 0);
        }
    }
    return ~crc;
}



uint32_t get_spi_flash_data_size(void){
	
  uint32_t flash_data_byte_size = SPI_FLASH_DATA_SIZE;
	
  return flash_data_byte_size;
}



//缓冲区大小
#define CACHE_BUFFER_SIZE 4096

uint8_t  cache_buffer[CACHE_BUFFER_SIZE];

void spi_flash_datacheck(void)
{
   for(uint32_t address =0; address<=get_spi_flash_data_size();address+= CACHE_BUFFER_SIZE)	
   {	   
      spiflash_read(cache_buffer,address,sizeof(cache_buffer));  
	   
      uint32_t crc32_result = soft_calculate_crc32(cache_buffer,sizeof(cache_buffer));
	  
      //检测crc 32结果错误	   
	  if(crc32_result!= data_crc32_4k[address/CACHE_BUFFER_SIZE])
	  {
		  printf("failed crc32 address:%08x\r\n",address);
		  printf("failed crc32_result is:%08x\r\n",crc32_result);
		  printf("correct crc32_result is:%08x\r\n",data_crc32_4k[address/CACHE_BUFFER_SIZE]);
		  
		  //检测到第一个crc32错误  直接退出不检测后续值
		  return;
	  }	   	   
   }
}


